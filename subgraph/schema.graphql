# FumaSwap V4 Subgraph Schema
# Tracks pools, swaps, liquidity, and positions for analytics

# Global factory/protocol statistics
type Factory @entity {
  id: ID! # "factory"
  poolCount: BigInt!
  txCount: BigInt!
  totalVolumeUSD: BigDecimal!
  totalVolumeFUMA: BigDecimal!
  totalFeesUSD: BigDecimal!
  totalValueLockedUSD: BigDecimal!
  totalValueLockedFUMA: BigDecimal!
  owner: Bytes!
}

# Token entity
type Token @entity {
  id: ID! # token address
  symbol: String!
  name: String!
  decimals: BigInt!
  totalSupply: BigInt!
  volume: BigDecimal!
  volumeUSD: BigDecimal!
  untrackedVolumeUSD: BigDecimal!
  feesUSD: BigDecimal!
  txCount: BigInt!
  poolCount: BigInt!
  totalValueLocked: BigDecimal!
  totalValueLockedUSD: BigDecimal!
  derivedFUMA: BigDecimal!

  # Token day data
  tokenDayData: [TokenDayData!]! @derivedFrom(field: "token")

  # Pools containing this token
  whitelistPools: [Pool!]!
}

# Pool entity - concentrated liquidity pool
type Pool @entity {
  id: ID! # pool id (bytes32)
  token0: Token!
  token1: Token!
  fee: BigInt!
  tickSpacing: BigInt!
  hooks: Bytes!

  # Pool state
  liquidity: BigInt!
  sqrtPrice: BigInt!
  tick: BigInt

  # Fee tracking
  feeGrowthGlobal0X128: BigInt!
  feeGrowthGlobal1X128: BigInt!
  protocolFee: BigInt!

  # Price tracking
  token0Price: BigDecimal!
  token1Price: BigDecimal!

  # Volume tracking
  volumeToken0: BigDecimal!
  volumeToken1: BigDecimal!
  volumeUSD: BigDecimal!
  untrackedVolumeUSD: BigDecimal!
  feesUSD: BigDecimal!

  # Transaction count
  txCount: BigInt!

  # TVL tracking
  totalValueLockedToken0: BigDecimal!
  totalValueLockedToken1: BigDecimal!
  totalValueLockedUSD: BigDecimal!
  totalValueLockedFUMA: BigDecimal!

  # Lifecycle
  createdAtTimestamp: BigInt!
  createdAtBlockNumber: BigInt!

  # Aggregated data
  poolDayData: [PoolDayData!]! @derivedFrom(field: "pool")
  poolHourData: [PoolHourData!]! @derivedFrom(field: "pool")

  # Liquidity positions
  mints: [Mint!]! @derivedFrom(field: "pool")
  burns: [Burn!]! @derivedFrom(field: "pool")
  swaps: [Swap!]! @derivedFrom(field: "pool")
  collects: [Collect!]! @derivedFrom(field: "pool")
  ticks: [Tick!]! @derivedFrom(field: "pool")
}

# Tick entity for liquidity distribution
type Tick @entity {
  id: ID! # pool address + tick index
  poolAddress: Bytes!
  pool: Pool!
  tickIdx: BigInt!
  liquidityGross: BigInt!
  liquidityNet: BigInt!
  price0: BigDecimal!
  price1: BigDecimal!

  # Fee growth outside
  feeGrowthOutside0X128: BigInt!
  feeGrowthOutside1X128: BigInt!

  createdAtTimestamp: BigInt!
  createdAtBlockNumber: BigInt!
}

# NFT Position entity
type Position @entity {
  id: ID! # NFT token id
  owner: Bytes!
  pool: Pool!
  token0: Token!
  token1: Token!
  tickLower: Tick!
  tickUpper: Tick!
  liquidity: BigInt!

  # Token amounts
  depositedToken0: BigDecimal!
  depositedToken1: BigDecimal!
  withdrawnToken0: BigDecimal!
  withdrawnToken1: BigDecimal!

  # Fees collected
  collectedFeesToken0: BigDecimal!
  collectedFeesToken1: BigDecimal!

  # Fee growth tracking
  feeGrowthInside0LastX128: BigInt!
  feeGrowthInside1LastX128: BigInt!

  # Lifecycle
  createdAtTimestamp: BigInt!
  createdAtBlockNumber: BigInt!

  # Transaction reference
  transaction: Transaction!
}

# Position snapshot for historical tracking
type PositionSnapshot @entity {
  id: ID! # position id + timestamp
  owner: Bytes!
  pool: Pool!
  position: Position!
  timestamp: BigInt!
  blockNumber: BigInt!
  liquidity: BigInt!
  depositedToken0: BigDecimal!
  depositedToken1: BigDecimal!
  withdrawnToken0: BigDecimal!
  withdrawnToken1: BigDecimal!
  collectedFeesToken0: BigDecimal!
  collectedFeesToken1: BigDecimal!
  transaction: Transaction!
  feeGrowthInside0LastX128: BigInt!
  feeGrowthInside1LastX128: BigInt!
}

# Transaction entity
type Transaction @entity {
  id: ID! # transaction hash
  blockNumber: BigInt!
  timestamp: BigInt!
  gasUsed: BigInt!
  gasPrice: BigInt!

  # Related events
  mints: [Mint!]! @derivedFrom(field: "transaction")
  burns: [Burn!]! @derivedFrom(field: "transaction")
  swaps: [Swap!]! @derivedFrom(field: "transaction")
  collects: [Collect!]! @derivedFrom(field: "transaction")
}

# Mint event (add liquidity)
type Mint @entity(immutable: true) {
  id: ID! # transaction hash + log index
  transaction: Transaction!
  timestamp: BigInt!
  pool: Pool!
  token0: Token!
  token1: Token!
  owner: Bytes!
  sender: Bytes!
  origin: Bytes! # tx origin
  amount: BigInt! # liquidity amount
  amount0: BigDecimal!
  amount1: BigDecimal!
  amountUSD: BigDecimal
  tickLower: BigInt!
  tickUpper: BigInt!
  logIndex: BigInt
}

# Burn event (remove liquidity)
type Burn @entity(immutable: true) {
  id: ID! # transaction hash + log index
  transaction: Transaction!
  timestamp: BigInt!
  pool: Pool!
  token0: Token!
  token1: Token!
  owner: Bytes!
  origin: Bytes! # tx origin
  amount: BigInt! # liquidity amount
  amount0: BigDecimal!
  amount1: BigDecimal!
  amountUSD: BigDecimal
  tickLower: BigInt!
  tickUpper: BigInt!
  logIndex: BigInt
}

# Swap event
type Swap @entity(immutable: true) {
  id: ID! # transaction hash + log index
  transaction: Transaction!
  timestamp: BigInt!
  pool: Pool!
  token0: Token!
  token1: Token!
  sender: Bytes!
  recipient: Bytes!
  origin: Bytes! # tx origin
  amount0: BigDecimal!
  amount1: BigDecimal!
  amountUSD: BigDecimal!
  sqrtPriceX96: BigInt!
  tick: BigInt!
  logIndex: BigInt
}

# Collect event (collect fees)
type Collect @entity(immutable: true) {
  id: ID! # transaction hash + log index
  transaction: Transaction!
  timestamp: BigInt!
  pool: Pool!
  owner: Bytes
  amount0: BigDecimal!
  amount1: BigDecimal!
  amountUSD: BigDecimal
  tickLower: BigInt!
  tickUpper: BigInt!
  logIndex: BigInt
}

# Daily aggregated data for the protocol
type FumaSwapDayData @entity {
  id: ID! # timestamp / 86400
  date: Int!
  volumeUSD: BigDecimal!
  volumeFUMA: BigDecimal!
  feesUSD: BigDecimal!
  tvlUSD: BigDecimal!
  txCount: BigInt!
}

# Daily aggregated data per pool
type PoolDayData @entity {
  id: ID! # pool address + day id
  date: Int!
  pool: Pool!

  # Liquidity
  liquidity: BigInt!
  sqrtPrice: BigInt!
  tick: BigInt

  # Price
  token0Price: BigDecimal!
  token1Price: BigDecimal!

  # Volume
  volumeToken0: BigDecimal!
  volumeToken1: BigDecimal!
  volumeUSD: BigDecimal!

  # Fees
  feesUSD: BigDecimal!

  # TVL
  tvlUSD: BigDecimal!

  # Transaction count
  txCount: BigInt!

  # Opening values
  open: BigDecimal!
  high: BigDecimal!
  low: BigDecimal!
  close: BigDecimal!
}

# Hourly aggregated data per pool
type PoolHourData @entity {
  id: ID! # pool address + hour id
  periodStartUnix: Int!
  pool: Pool!

  # Liquidity
  liquidity: BigInt!
  sqrtPrice: BigInt!
  tick: BigInt

  # Price
  token0Price: BigDecimal!
  token1Price: BigDecimal!

  # Volume
  volumeToken0: BigDecimal!
  volumeToken1: BigDecimal!
  volumeUSD: BigDecimal!

  # Fees
  feesUSD: BigDecimal!

  # TVL
  tvlUSD: BigDecimal!

  # Transaction count
  txCount: BigInt!

  # OHLC
  open: BigDecimal!
  high: BigDecimal!
  low: BigDecimal!
  close: BigDecimal!
}

# Daily aggregated data per token
type TokenDayData @entity {
  id: ID! # token address + day id
  date: Int!
  token: Token!

  # Volume
  volume: BigDecimal!
  volumeUSD: BigDecimal!
  untrackedVolumeUSD: BigDecimal!

  # TVL
  totalValueLocked: BigDecimal!
  totalValueLockedUSD: BigDecimal!

  # Price
  priceUSD: BigDecimal!

  # Fees
  feesUSD: BigDecimal!

  # OHLC
  open: BigDecimal!
  high: BigDecimal!
  low: BigDecimal!
  close: BigDecimal!
}

# Token hour data
type TokenHourData @entity {
  id: ID! # token address + hour id
  periodStartUnix: Int!
  token: Token!

  # Volume
  volume: BigDecimal!
  volumeUSD: BigDecimal!
  untrackedVolumeUSD: BigDecimal!

  # TVL
  totalValueLocked: BigDecimal!
  totalValueLockedUSD: BigDecimal!

  # Price
  priceUSD: BigDecimal!

  # Fees
  feesUSD: BigDecimal!

  # OHLC
  open: BigDecimal!
  high: BigDecimal!
  low: BigDecimal!
  close: BigDecimal!
}
